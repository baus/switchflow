<HTML>
  <HEAD>
    <TITLE>asio Tutorial: Daytime.1 - A synchronous TCP daytime client</TITLE>
    <LINK HREF="asio.css" REL="stylesheet" TYPE="text/css">
    <LINK HREF="tabs.css" REL="stylesheet" TYPE="text/css">
  </HEAD>
  <BODY BGCOLOR="#FFFFFF">
    <DIV CLASS="qindex">
      <TABLE BORDER="0" WIDTH="100%">
        <TR>
          <TD ALIGN="LEFT">
            <B>asio 0.3.7</B>
          </TD>
          <TD ALIGN="RIGHT">
            <A CLASS="qindex" HREF="../index.html">Home</A> |
            <A CLASS="qindex" HREF="../reference/index.html">Reference</A> |
            <A CLASS="qindex" HREF="../tutorial/index.html">Tutorial</A> |
            <A CLASS="qindex" HREF="../examples/index.html">Examples</A> |
            <A CLASS="qindex" HREF="../design/index.html">Design</A>
          </TD>
        </TR>
      </TABLE>
    </DIV>
    <DIV CLASS="qindex">
      <TABLE BORDER="0" WIDTH="100%">
        <TR>
          <TD ALIGN="LEFT">
            <B>Tutorial</B>
          </TD>
        </TR>
      </TABLE>
    </DIV>
<!-- Generated by Doxygen 1.4.7 -->
<h1><a class="anchor" name="tutdaytime1">Daytime.1 - A synchronous TCP daytime client</a></h1>This tutorial program shows how to use asio to implement a client application with TCP.<p>
<p>
We start by including the necessary header files.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;iostream&gt;</span>
<span class="preprocessor">#include &lt;boost/array.hpp&gt;</span>
<span class="preprocessor">#include &lt;asio.hpp&gt;</span>
</pre></div><p>
The purpose of this application is to access a daytime service, so we need the user to specify the server.<p>
<div class="fragment"><pre class="fragment">
<span class="keyword">using</span> <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00168.html">asio::ip::tcp</a>;

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
{
  <span class="keywordflow">try</span>
  {
    <span class="keywordflow">if</span> (argc != 2)
    {
      std::cerr &lt;&lt; <span class="stringliteral">"Usage: client &lt;host&gt;"</span> &lt;&lt; std::endl;
      <span class="keywordflow">return</span> 1;
    }
</pre></div><p>
All programs that use asio need to have at least one <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00140.html">asio::io_service</a> object.<p>
<div class="fragment"><pre class="fragment">
    <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00140.html">asio::io_service</a> io_service;
</pre></div><p>
We need to turn the server name that was specified as a parameter to the application, into a TCP endpoint. To do this we use an <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00168.html#5e41beb40a92f3bde7563645c2fe5f6c">asio::ip::tcp::resolver</a> object.<p>
<div class="fragment"><pre class="fragment">
    tcp::resolver resolver(io_service);
</pre></div><p>
A resolver takes a query object and turns it into a list of endpoints. We construct a query using the name of the server, specified in <code>argv[1]</code>, and the name of the service, in this case <code>"daytime"</code>.<p>
<div class="fragment"><pre class="fragment">    tcp::resolver::query query(argv[1], <span class="stringliteral">"daytime"</span>);
</pre></div><p>
The list of endpoints is returned using an iterator of type <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00109.html#4d8fef02de5e7db6dd1614f3d8325ea3">asio::ip::tcp::resolver::iterator</a>. A default constructed <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00109.html#4d8fef02de5e7db6dd1614f3d8325ea3">asio::ip::tcp::resolver::iterator</a> object is used as the end iterator.<p>
<div class="fragment"><pre class="fragment">    tcp::resolver::iterator endpoint_iterator = resolver.resolve(query);
    tcp::resolver::iterator end;
</pre></div><p>
Now we create and connect the socket. The list of endpoints obtained above may contain both IPv4 and IPv6 endpoints, so we need to try each of them until we find one that works. This keeps the client program independent of a specific IP version.<p>
<div class="fragment"><pre class="fragment">
    tcp::socket socket(io_service);
    <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00135.html">asio::error</a> <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00266.html#b652117cf6b85d856a2cada43e562b3a">error</a> = <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00135.html#07d16ab7bd80c0b67c2286817d02bd47f64fcddcd2e17022dfffe63ff8b34824">asio::error::host_not_found</a>;
    <span class="keywordflow">while</span> (error &amp;&amp; endpoint_iterator != end)
    {
      socket.close();
      socket.connect(*endpoint_iterator++, <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00272.html#g3acdd36b40ce607c82b0ad32ad1502e8">asio::assign_error</a>(error));
    }
    <span class="keywordflow">if</span> (error)
      <span class="keywordflow">throw</span> error;
</pre></div><p>
The connection is open. All we need to do now is read the response from the daytime service.<p>
We use a <code>boost::array</code> to hold the received data. The <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00270.html#ga5592a9ee32b5c753466edc0af005edb">asio::buffer()</a> function automatically determines the size of the array to help prevent buffer overruns. Instead of a <code>boost::array</code>, we could have used a <code>char []</code> or <code>std::vector</code>.<p>
<div class="fragment"><pre class="fragment">
    <span class="keywordflow">for</span> (;;)
    {
      boost::array&lt;char, 128&gt; buf;
      <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00135.html">asio::error</a> error;

      size_t len = socket.read_some(
          <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00270.html#ga5592a9ee32b5c753466edc0af005edb">asio::buffer</a>(buf), <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00272.html#g3acdd36b40ce607c82b0ad32ad1502e8">asio::assign_error</a>(error));
</pre></div><p>
When the server closes the connection, the <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00118.html#938802e8def6d1218890e888975c6e5f">asio::ip::tcp::socket::read_some()</a> function will exit with the <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00135.html#07d16ab7bd80c0b67c2286817d02bd47bb0b3b47deff67dd67b180d9d1e34154">asio::error::eof</a> error, which is how we know to exit the loop.<p>
<div class="fragment"><pre class="fragment">
      <span class="keywordflow">if</span> (error == <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00135.html#07d16ab7bd80c0b67c2286817d02bd47bb0b3b47deff67dd67b180d9d1e34154">asio::error::eof</a>)
        <span class="keywordflow">break</span>; <span class="comment">// Connection closed cleanly by peer.</span>
      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error)
        <span class="keywordflow">throw</span> error; <span class="comment">// Some other error.</span>

      std::cout.write(buf.data(), len);
    }
</pre></div><p>
Finally, handle any exceptions that may have been thrown.<p>
<div class="fragment"><pre class="fragment">  }
  <span class="keywordflow">catch</span> (std::exception&amp; e)
  {
    std::cerr &lt;&lt; e.what() &lt;&lt; std::endl;
  }
</pre></div><p>
See the <a class="el" href="tutdaytime1src.html">full source listing</a> <br>
 Return to the <a class="el" href="index.html#index">tutorial index</a> <br>
 Next: <a class="el" href="tutdaytime2.html">Daytime.2 - A synchronous TCP daytime server</a>     <DIV CLASS="qindex">
      <TABLE BORDER="0" WIDTH="100%">
        <TR>
          <TD ALIGN="LEFT">
            <B>asio 0.3.7</B>
          </TD>
          <TD ALIGN="RIGHT">
            <A CLASS="qindex" HREF="../index.html">Home</A> |
            <A CLASS="qindex" HREF="../reference/index.html">Reference</A> |
            <A CLASS="qindex" HREF="../tutorial/index.html">Tutorial</A> |
            <A CLASS="qindex" HREF="../examples/index.html">Examples</A> |
            <A CLASS="qindex" HREF="../design/index.html">Design</A>
          </TD>
        </TR>
      </TABLE>
    </DIV>
  </BODY>
</HTML>
