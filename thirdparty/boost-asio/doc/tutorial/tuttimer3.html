<HTML>
  <HEAD>
    <TITLE>asio Tutorial: Timer.3 - Binding arguments to a handler</TITLE>
    <LINK HREF="asio.css" REL="stylesheet" TYPE="text/css">
    <LINK HREF="tabs.css" REL="stylesheet" TYPE="text/css">
  </HEAD>
  <BODY BGCOLOR="#FFFFFF">
    <DIV CLASS="qindex">
      <TABLE BORDER="0" WIDTH="100%">
        <TR>
          <TD ALIGN="LEFT">
            <B>asio 0.3.7</B>
          </TD>
          <TD ALIGN="RIGHT">
            <A CLASS="qindex" HREF="../index.html">Home</A> |
            <A CLASS="qindex" HREF="../reference/index.html">Reference</A> |
            <A CLASS="qindex" HREF="../tutorial/index.html">Tutorial</A> |
            <A CLASS="qindex" HREF="../examples/index.html">Examples</A> |
            <A CLASS="qindex" HREF="../design/index.html">Design</A>
          </TD>
        </TR>
      </TABLE>
    </DIV>
    <DIV CLASS="qindex">
      <TABLE BORDER="0" WIDTH="100%">
        <TR>
          <TD ALIGN="LEFT">
            <B>Tutorial</B>
          </TD>
        </TR>
      </TABLE>
    </DIV>
<!-- Generated by Doxygen 1.4.7 -->
<h1><a class="anchor" name="tuttimer3">Timer.3 - Binding arguments to a handler</a></h1>In this tutorial we will modify the program from tutorial Timer.2 so that the timer fires once a second. This will show how to pass additional parameters to your handler function.<p>
<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;iostream&gt;</span>
<span class="preprocessor">#include &lt;asio.hpp&gt;</span>
<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span>
<span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span>
</pre></div><p>
To implement a repeating timer using asio you need to change the timer's expiry time in your callback function, and to then start a new asynchronous wait. Obviously this means that the callback function will need to be able to access the timer object. To this end we add two new parameters to the <code>print</code> function:<p>
<ul>
<li>A pointer to a timer object.</li>
</ul>
<ul>
<li>A counter so that we can stop the program when the timer fires for the sixth time.</li>
</ul>
<div class="fragment"><pre class="fragment">
<span class="keywordtype">void</span> print(<span class="keyword">const</span> <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00135.html">asio::error</a>&amp; <span class="comment">/*e*/</span>,
    <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html">asio::deadline_timer</a>* t, <span class="keywordtype">int</span>* count)
{
</pre></div><p>
As mentioned above, this tutorial program uses a counter to stop running when the timer fires for the sixth time. However you will observe that there is no explicit call to ask the io_service to stop. Recall that in tutorial Timer.2 we learnt that the <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00140.html#50ae7753f2c851cd3e91724bbfc5b444">asio::io_service::run()</a> function completes when there is no more "work" to do. By not starting a new asynchronous wait on the timer when <code>count</code> reaches 5, the io_service will run out of work and stop running.<p>
<div class="fragment"><pre class="fragment">  <span class="keywordflow">if</span> (*count &lt; 5)
  {
    std::cout &lt;&lt; *count &lt;&lt; <span class="stringliteral">"\n"</span>;
    ++(*count);
</pre></div><p>
Next we move the expiry time for the timer along by one second from the previous expiry time. By calculating the new expiry time relative to the old, we can ensure that the timer does not drift away from the whole-second mark due to any delays in processing the handler.<p>
<div class="fragment"><pre class="fragment">
    t-&gt;<a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html#c22579abaf85705b45b2b8aa3d553fd1">expires_at</a>(t-&gt;<a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html#c22579abaf85705b45b2b8aa3d553fd1">expires_at</a>() + boost::posix_time::seconds(1));
</pre></div><p>
Then we start a new asynchronous wait on the timer. As you can see, the <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/boost_bind.html">boost::bind</a> function is used to associate the extra parameters with your callback handler. The <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html#2ad7fdf0eb7a53cea40aa1409b899ab7">asio::deadline_timer::async_wait()</a> function expects a handler function (or function object) with the signature <code>void(const asio::error&amp;)</code>. Binding the additional parameters converts your <code>print</code> function into a function object that matches the signature correctly.<p>
See the <a href="http://www.boost.org/libs/bind/bind.html">Boost: bind.hpp documentation</a> for more information on how to use <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/boost_bind.html">boost::bind</a>.<p>
In this example, the <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00266.html#b652117cf6b85d856a2cada43e562b3a">asio::placeholders::error</a> argument to <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/boost_bind.html">boost::bind</a> is a named placeholder for the error object passed to the handler. When initiating the asynchronous operation, and if using <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/boost_bind.html">boost::bind</a>, you must specify only the arguments that match the handler's parameter list. In tutorial Timer.4 you will see that this placeholder may be elided if the parameter is not needed by the callback handler.<p>
<div class="fragment"><pre class="fragment">    t-&gt;<a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html#2ad7fdf0eb7a53cea40aa1409b899ab7">async_wait</a>(boost::bind(print,
          <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00266.html#b652117cf6b85d856a2cada43e562b3a">asio::placeholders::error</a>, t, count));
  }
}

<span class="keywordtype">int</span> main()
{
  <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00140.html">asio::io_service</a> io;
</pre></div><p>
A new <code>count</code> variable is added so that we can stop the program when the timer fires for the sixth time.<p>
<div class="fragment"><pre class="fragment">
  <span class="keywordtype">int</span> count = 0;
  <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html">asio::deadline_timer</a> t(io, boost::posix_time::seconds(1));
</pre></div><p>
As in Step 4, when making the call to <a class="elRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html#2ad7fdf0eb7a53cea40aa1409b899ab7">asio::deadline_timer::async_wait()</a> from <code>main</code> we bind the additional parameters needed for the <code>print</code> function.<p>
<div class="fragment"><pre class="fragment">  t.<a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00106.html#2ad7fdf0eb7a53cea40aa1409b899ab7">async_wait</a>(boost::bind(print,
        <a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00266.html#b652117cf6b85d856a2cada43e562b3a">asio::placeholders::error</a>, &amp;t, &amp;count));

  io.<a class="codeRef" doxygen="asio.doxytags:../reference/" href="../reference/a00140.html#50ae7753f2c851cd3e91724bbfc5b444">run</a>();
</pre></div><p>
Finally, just to prove that the <code>count</code> variable was being used in the <code>print</code> handler function, we will print out its new value.<p>
<div class="fragment"><pre class="fragment">
  std::cout &lt;&lt; <span class="stringliteral">"Final count is "</span> &lt;&lt; count &lt;&lt; <span class="stringliteral">"\n"</span>;

  <span class="keywordflow">return</span> 0;
}
</pre></div><p>
See the <a class="el" href="tuttimer3src.html">full source listing</a> <br>
 Return to the <a class="el" href="index.html#index">tutorial index</a> <br>
 Previous: <a class="el" href="tuttimer2.html">Timer.2 - Using a timer asynchronously</a> <br>
 Next: <a class="el" href="tuttimer4.html">Timer.4 - Using a member function as a handler</a>     <DIV CLASS="qindex">
      <TABLE BORDER="0" WIDTH="100%">
        <TR>
          <TD ALIGN="LEFT">
            <B>asio 0.3.7</B>
          </TD>
          <TD ALIGN="RIGHT">
            <A CLASS="qindex" HREF="../index.html">Home</A> |
            <A CLASS="qindex" HREF="../reference/index.html">Reference</A> |
            <A CLASS="qindex" HREF="../tutorial/index.html">Tutorial</A> |
            <A CLASS="qindex" HREF="../examples/index.html">Examples</A> |
            <A CLASS="qindex" HREF="../design/index.html">Design</A>
          </TD>
        </TR>
      </TABLE>
    </DIV>
  </BODY>
</HTML>
